# Keeps and Breaks

## Overview

Keeps and breaks are constraints that control how formatting objects are distributed across context-areas such as pages, columns, and lines. Break conditions force content to start at the beginning of a new context-area, while keep conditions prevent content from being split across context-area boundaries. Understanding how these constraints interact with the area model is essential for controlling pagination and line-breaking behavior in XSL-FO.

<!-- Source: https://www.w3.org/TR/xslfo20/#keepbreak -->

## Context and Context-Areas

Keep and break conditions apply to a class of areas referred to as a **context**. An area in this class is a **context-area**. The typical context-area classes are:

- **Page-reference-areas** -- areas generated by an `fo:page-sequence` using the specifications in an `fo:page-master`.
- **Column-areas** -- normal-flow-reference-areas generated from a region-body, or region-reference-areas generated from other types of region-master.
- **Line-areas** -- lines generated during inline formatting.

## Leading and Trailing Areas

Keep and break conditions are defined in terms of **leading** and **trailing** areas within a context-area.

If area `A` is a descendant of area `P`, then:

- `A` is **leading** in `P` if `A` has no preceding sibling which is a normal area, nor does any of its ancestor areas up to but not including `P`.
- `A` is **trailing** in `P` if `A` has no following sibling which is a normal area, nor does any of its ancestor areas up to but not including `P`.

The **next** formatting object in the flow (relative to a given formatting object) is the first formatting object following in the pre-order traversal order which is not a descendant of the given formatting object and which generates and returns normal areas.

## Break Conditions

Break conditions are either `break-before` or `break-after` conditions:

- A **`break-before`** condition is **satisfied** if the first area generated and returned by the formatting object is leading within a context-area.
- A **`break-after`** condition depends on the next formatting object in the flow. The condition is satisfied if either there is no such next formatting object, or if the first normal area generated and returned by that formatting object is leading in a context-area.

### Break Condition Values

Break conditions are imposed by the `break-before` and `break-after` properties. The refined value determines the context:

| Value | Context |
|---|---|
| `page` | Page-reference-areas |
| `even-page` | Even-numbered page-reference-areas |
| `odd-page` | Odd-numbered page-reference-areas |
| `column` | Column-areas |
| `auto` | No break condition imposed |

## Keep Conditions

Keep conditions are either `keep-with-previous`, `keep-with-next`, or `keep-together` conditions:

- A **`keep-with-previous`** condition on an object is satisfied if the first area generated and returned by the formatting object is not leading within a context-area, or if there are no preceding areas in a post-order traversal of the area tree.
- A **`keep-with-next`** condition is satisfied if the last area generated and returned by the formatting object is not trailing within a context-area, or if there are no following areas in a pre-order traversal of the area tree.
- A **`keep-together`** condition is satisfied if all areas generated and returned by the formatting object are descendants of a single context-area.

### Keep Condition Components and Strength

Keep conditions are imposed by the `within-page`, `within-column`, and `within-line` components of the `keep-with-previous`, `keep-with-next`, and `keep-together` properties:

| Component | Context |
|---|---|
| `within-page` | Page-reference-areas |
| `within-column` | Column-areas |
| `within-line` | Line-areas |

The refined value of each component specifies the **strength** of the keep condition:

- Higher numbers are stronger than lower numbers.
- The value `always` is stronger than all numeric values.
- A component with value `auto` does not impose a keep condition.

### Keep Property Shorthand vs. Expanded Form

The `<keep>` compound datatype supports both shorthand and expanded notation:

<!-- Source: xslspec.xml line 5919 -->
```xml
keep-together="always"
```

is equivalent to:

<!-- Source: xslspec.xml line 5923 -->
```xml
keep-together.within-line="always"
keep-together.within-column="always"
keep-together.within-page="always"
```

The shorthand assigns the same value to all three components. When using both forms, the expanded (component) form takes precedence over the shorthand expansion. For example, `keep-together="always" keep-together.within-line="auto"` results in `within-column="always"`, `within-page="always"`, but `within-line="auto"`.

## Constraint Resolution

The area tree is constrained to satisfy **all** break conditions imposed.

Each keep condition must also be satisfied, except when this would cause a break condition or a stronger keep condition to fail to be satisfied. If not all of a set of keep conditions of equal strength can be satisfied, then some **maximal satisfiable subset** of conditions of that strength must be satisfied, together with all break conditions and maximal subsets of stronger keep conditions, if any.

In other words, the priority order is:

1. Break conditions (always satisfied)
2. Stronger keep conditions (satisfied before weaker ones)
3. Weaker keep conditions (satisfied to the extent possible without violating higher-priority constraints)

## Widows and Orphans

The `widows` and `orphans` properties control the minimum number of lines at page/column boundaries:

- **`orphans`** (default: `2`): Minimum number of line-areas in the **first** area generated by a block (i.e., lines left at the bottom of a page before a break).
- **`widows`** (default: `2`): Minimum number of line-areas in the **last** area generated by a block (i.e., lines carried to the top of a new page after a break).

Both are inherited and apply to block-level formatting objects. They are soft constraints — the formatter will try to satisfy them but may not if content cannot be distributed otherwise.

## CSS Shorthand Mappings

XSL-FO treats the CSS page-break properties as shorthands:

| CSS Property | CSS Value | XSL-FO Mapping |
|---|---|---|
| `page-break-before` | `always` | `break-before="page"` |
| `page-break-before` | `avoid` | `keep-with-previous.within-page="always"` |
| `page-break-after` | `always` | `break-after="page"` |
| `page-break-after` | `avoid` | `keep-with-next.within-page="always"` |
| `page-break-inside` | `avoid` | `keep-together.within-page="always"` |
| `page-break-before` | `left` | `break-before="even-page"` |
| `page-break-before` | `right` | `break-before="odd-page"` |

The native XSL-FO properties (`break-before`, `keep-together`, etc.) are more expressive because they support column-level and line-level contexts and numeric strength values.

## Code Samples

### Spec Example: Chapter Page Breaks with break-before

This XSLT stylesheet uses `break-before="page"` to force each chapter to start on a new page:

<!-- Source: xslspec.xml line 9976 -->
```xml
<?xml version="1.0" encoding="utf-8"?>
<xsl:stylesheet
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:fo="http://www.w3.org/1999/XSL/Format">

<xsl:template match="chapter">
  <fo:block break-before="page">
    <xsl:apply-templates/>
  </fo:block>
</xsl:template>

<xsl:template match="chapter/title">
  <fo:block text-align="center" space-after="8pt"
            space-before="16pt" space-after.precedence="3">
    <xsl:apply-templates/>
  </fo:block>
</xsl:template>

<xsl:template match="section">
  <xsl:apply-templates/>
</xsl:template>

<xsl:template match="section/title">
  <fo:block text-align="center" space-after="6pt"
            space-before="12pt" space-before.precedence="0"
            space-after.precedence="3">
    <xsl:apply-templates/>
  </fo:block>
</xsl:template>

<xsl:template match="paragraph[1]" priority="1">
  <fo:block text-indent="0pc" space-after="7pt"
            space-before.minimum="6pt" space-before.optimum="8pt"
            space-before.maximum="10pt">
    <xsl:apply-templates/>
  </fo:block>
</xsl:template>

<xsl:template match="paragraph">
  <fo:block text-indent="2pc" space-after="7pt"
            space-before.minimum="6pt" space-before.optimum="8pt"
            space-before.maximum="10pt">
    <xsl:apply-templates/>
  </fo:block>
</xsl:template>

</xsl:stylesheet>
```

The resulting XSL-FO output:

<!-- Source: xslspec.xml line 10027 -->
```xml
<fo:block break-before="page">

  <fo:block text-align="center" space-after="8pt"
    space-before="16pt"
    space-after.precedence="3">Chapter title
  </fo:block>

  <fo:block text-align="center" space-after="6pt"
    space-before="12pt" space-before.precedence="0"
    space-after.precedence="3">First section title
  </fo:block>

  <fo:block text-indent="0pc" space-after="7pt"
    space-before.minimum="6pt" space-before.optimum="8pt"
    space-before.maximum="10pt">Section one's first paragraph.
  </fo:block>

  <fo:block text-indent="2pc" space-after="7pt"
    space-before.minimum="6pt" space-before.optimum="8pt"
    space-before.maximum="10pt">Section one's second paragraph.
  </fo:block>

  <fo:block text-align="center" space-after="6pt"
    space-before="12pt" space-before.precedence="0"
    space-after.precedence="3">Second section title
  </fo:block>

  <fo:block text-indent="0pc" space-after="7pt"
    space-before.minimum="6pt" space-before.optimum="8pt"
    space-before.maximum="10pt">Section two's only paragraph.
  </fo:block>

</fo:block>
```

### Constructed Example: Complete Document with Keeps, Breaks, and Widow/Orphan Control

**Note: This is a constructed example, not from the spec.**

This complete XSL-FO document demonstrates multiple keeps and breaks techniques in a realistic document structure:

```xml
<fo:root xmlns:fo="http://www.w3.org/1999/XSL/Format">
  <fo:layout-master-set>
    <fo:simple-page-master master-name="page"
        page-height="11in" page-width="8.5in"
        margin-top="1in" margin-bottom="1in"
        margin-left="1.25in" margin-right="1in">
      <fo:region-body margin-top="0.5in" margin-bottom="0.5in"/>
      <fo:region-before extent="0.4in"/>
      <fo:region-after extent="0.4in"/>
    </fo:simple-page-master>
  </fo:layout-master-set>

  <fo:page-sequence master-reference="page">
    <fo:static-content flow-name="xsl-region-after">
      <fo:block text-align="center" font-size="9pt">
        Page <fo:page-number/>
      </fo:block>
    </fo:static-content>

    <fo:flow flow-name="xsl-region-body">

      <!-- TECHNIQUE 1: Force a page break before a chapter heading -->
      <fo:block font-size="18pt" font-weight="bold"
          space-after="12pt" break-before="page"
          keep-with-next.within-page="always">
        Chapter 1: Introduction
      </fo:block>

      <!-- TECHNIQUE 2: keep-with-next prevents heading from being
           orphaned at the bottom of a page without its first paragraph -->
      <fo:block font-size="14pt" font-weight="bold"
          space-before="18pt" space-after="8pt"
          keep-with-next.within-page="always">
        1.1 Background
      </fo:block>

      <!-- Set widows and orphans to prevent single-line fragments -->
      <fo:block space-after="6pt" orphans="3" widows="3">
        This paragraph has widows="3" and orphans="3", meaning at least
        three lines must remain at the bottom of a page before a break
        (orphans) and at least three lines must appear at the top of
        the next page after a break (widows). This provides better
        visual appearance than the default of 2 lines. The formatter
        will move content between pages to satisfy these constraints
        whenever possible.
      </fo:block>

      <fo:block space-after="6pt">
        A regular paragraph with default widows and orphans (both 2).
        Content flows normally here.
      </fo:block>

      <!-- TECHNIQUE 3: keep-together prevents a block from splitting -->
      <fo:block keep-together.within-page="always"
          border="1pt solid black" padding="8pt"
          space-before="12pt" space-after="12pt"
          background-color="#f5f5f5">
        <fo:block font-weight="bold" space-after="4pt">
          Important Notice
        </fo:block>
        <fo:block>
          This entire notice box must appear on a single page. The
          keep-together.within-page="always" property prevents the
          formatter from splitting this block across a page boundary.
          If the block does not fit on the current page, it will be
          moved entirely to the next page.
        </fo:block>
      </fo:block>

      <!-- TECHNIQUE 4: keep-with-next on a figure caption -->
      <fo:block text-align="center" space-before="12pt"
          keep-with-next.within-page="always">
        <fo:external-graphic src="figure1.png"
            content-width="4in"/>
      </fo:block>
      <fo:block text-align="center" font-size="10pt"
          font-style="italic" space-after="12pt"
          keep-with-previous.within-page="always">
        Figure 1: System Architecture Overview
      </fo:block>

      <!-- TECHNIQUE 5: Section heading with keep-with-next -->
      <fo:block font-size="14pt" font-weight="bold"
          space-before="18pt" space-after="8pt"
          keep-with-next.within-page="always">
        1.2 Problem Statement
      </fo:block>

      <fo:block space-after="6pt">
        Content of the problem statement section. This paragraph
        does not have special keep constraints and may break across
        pages as needed.
      </fo:block>

      <!-- TECHNIQUE 6: Numbered list kept together on one page -->
      <fo:list-block keep-together.within-page="always"
          space-before="8pt" space-after="8pt"
          provisional-distance-between-starts="18pt"
          provisional-label-separation="6pt">
        <fo:list-item space-after="4pt">
          <fo:list-item-label end-indent="label-end()">
            <fo:block>1.</fo:block>
          </fo:list-item-label>
          <fo:list-item-body start-indent="body-start()">
            <fo:block>First requirement: the system must handle
              concurrent requests.</fo:block>
          </fo:list-item-body>
        </fo:list-item>
        <fo:list-item space-after="4pt">
          <fo:list-item-label end-indent="label-end()">
            <fo:block>2.</fo:block>
          </fo:list-item-label>
          <fo:list-item-body start-indent="body-start()">
            <fo:block>Second requirement: response time under
              200ms.</fo:block>
          </fo:list-item-body>
        </fo:list-item>
        <fo:list-item>
          <fo:list-item-label end-indent="label-end()">
            <fo:block>3.</fo:block>
          </fo:list-item-label>
          <fo:list-item-body start-indent="body-start()">
            <fo:block>Third requirement: 99.9% uptime
              guarantee.</fo:block>
          </fo:list-item-body>
        </fo:list-item>
      </fo:list-block>

      <!-- TECHNIQUE 7: break-before="even-page" for chapter starts -->
      <fo:block font-size="18pt" font-weight="bold"
          space-after="12pt" break-before="even-page"
          keep-with-next.within-page="always">
        Chapter 2: Design
      </fo:block>

      <fo:block space-after="6pt">
        Using break-before="even-page" forces this chapter to begin
        on an even-numbered (left-hand) page. If the previous content
        ends on an even page, a blank odd page is inserted. Use
        break-before="odd-page" for chapters that should start on
        right-hand (odd) pages, which is the more common convention
        for books.
      </fo:block>

    </fo:flow>
  </fo:page-sequence>
</fo:root>
```

### Constructed Example: Table Row Keeps and Breaks

**Note: This is a constructed example, not from the spec.**

Tables have specific keep and break behaviors. Use keeps on table rows to prevent awkward splits:

```xml
<fo:table table-layout="fixed" width="100%" border-collapse="collapse"
    border="1pt solid black">
  <fo:table-column column-width="30%"/>
  <fo:table-column column-width="40%"/>
  <fo:table-column column-width="30%"/>

  <fo:table-header>
    <fo:table-row background-color="#2c3e50"
        keep-with-next.within-page="always">
      <fo:table-cell padding="6pt" border="1pt solid black">
        <fo:block color="white" font-weight="bold">Item</fo:block>
      </fo:table-cell>
      <fo:table-cell padding="6pt" border="1pt solid black">
        <fo:block color="white" font-weight="bold">Description</fo:block>
      </fo:table-cell>
      <fo:table-cell padding="6pt" border="1pt solid black">
        <fo:block color="white" font-weight="bold">Status</fo:block>
      </fo:table-cell>
    </fo:table-row>
  </fo:table-header>

  <fo:table-body>
    <!-- Group label row: always keep with the first data row -->
    <fo:table-row background-color="#ecf0f1"
        keep-with-next.within-page="always">
      <fo:table-cell number-columns-spanned="3" padding="6pt"
          border="1pt solid black">
        <fo:block font-weight="bold">Category A</fo:block>
      </fo:table-cell>
    </fo:table-row>

    <fo:table-row>
      <fo:table-cell padding="6pt" border="1pt solid black">
        <fo:block>Item A-1</fo:block>
      </fo:table-cell>
      <fo:table-cell padding="6pt" border="1pt solid black">
        <fo:block>Description of first item</fo:block>
      </fo:table-cell>
      <fo:table-cell padding="6pt" border="1pt solid black">
        <fo:block>Active</fo:block>
      </fo:table-cell>
    </fo:table-row>

    <fo:table-row>
      <fo:table-cell padding="6pt" border="1pt solid black">
        <fo:block>Item A-2</fo:block>
      </fo:table-cell>
      <fo:table-cell padding="6pt" border="1pt solid black">
        <fo:block>Description of second item</fo:block>
      </fo:table-cell>
      <fo:table-cell padding="6pt" border="1pt solid black">
        <fo:block>Pending</fo:block>
      </fo:table-cell>
    </fo:table-row>

    <!-- Force a page break before a new category -->
    <fo:table-row background-color="#ecf0f1"
        break-before="page"
        keep-with-next.within-page="always">
      <fo:table-cell number-columns-spanned="3" padding="6pt"
          border="1pt solid black">
        <fo:block font-weight="bold">Category B</fo:block>
      </fo:table-cell>
    </fo:table-row>

    <fo:table-row>
      <fo:table-cell padding="6pt" border="1pt solid black">
        <fo:block>Item B-1</fo:block>
      </fo:table-cell>
      <fo:table-cell padding="6pt" border="1pt solid black">
        <fo:block>Description of third item</fo:block>
      </fo:table-cell>
      <fo:table-cell padding="6pt" border="1pt solid black">
        <fo:block>Complete</fo:block>
      </fo:table-cell>
    </fo:table-row>
  </fo:table-body>
</fo:table>
```

**Table-specific keep/break notes:**
- `keep-with-next.within-page="always"` on a header row prevents the header from appearing alone at the bottom of a page.
- `break-before` and `break-after` on `fo:table-row` have no effect when row spanning includes both the current row and the adjacent row.
- `keep-together.within-page="always"` on an `fo:table-row` prevents that row's cells from being split across pages (useful for rows with multi-line content).
- `keep-together.within-page="always"` on the `fo:table` itself would force the entire table onto one page — use only for small tables.

### Constructed Example: Heading-to-Paragraph Keeps with Numeric Strength

**Note: This is a constructed example, not from the spec.**

Numeric keep strengths allow the formatter to prioritize which keeps to satisfy when not all can be honored:

```xml
<!-- Section heading: strong keep with its first paragraph -->
<fo:block font-size="14pt" font-weight="bold"
    space-before="18pt" space-after="8pt"
    keep-with-next.within-page="always">
  Section Title
</fo:block>

<!-- First paragraph: moderate keep with the next paragraph.
     The formatter will try to keep these together but will
     break here before breaking after the heading above. -->
<fo:block space-after="6pt"
    keep-with-next.within-page="5">
  First paragraph of the section, which should ideally stay
  on the same page as the second paragraph for readability.
</fo:block>

<fo:block space-after="6pt">
  Second paragraph. No special keep constraints.
</fo:block>
```

When the formatter cannot satisfy all keep conditions, it breaks weaker keeps first:
- `keep-with-next.within-page="always"` (heading-to-paragraph) is never broken unless physically impossible.
- `keep-with-next.within-page="5"` (paragraph-to-paragraph) may be broken if needed to satisfy the stronger keep above.
- A keep strength of `1` is the weakest explicit keep; `auto` imposes no constraint at all.

### Constructed Example: Column Breaks in Multi-Column Layout

**Note: This is a constructed example, not from the spec.**

In multi-column layouts, `break-before="column"` and `keep-together.within-column` control column breaks:

```xml
<fo:page-sequence master-reference="page">
  <fo:flow flow-name="xsl-region-body">
    <!-- Two-column layout via block-container or region-body column-count -->
    <fo:block font-size="18pt" font-weight="bold"
        space-after="12pt">
      Newsletter
    </fo:block>

    <!-- This article stays in one column -->
    <fo:block keep-together.within-column="always"
        space-after="12pt">
      <fo:block font-weight="bold" space-after="4pt">
        Short Article Title
      </fo:block>
      <fo:block>
        Brief article content that should not be split across
        columns. Using keep-together.within-column="always"
        ensures all content stays in a single column.
      </fo:block>
    </fo:block>

    <!-- Force the next article to start in a new column -->
    <fo:block break-before="column">
      <fo:block font-weight="bold" space-after="4pt">
        Second Article
      </fo:block>
      <fo:block>
        This article starts in a new column. In the last (or only)
        column, a column break implies a page break.
      </fo:block>
    </fo:block>
  </fo:flow>
</fo:page-sequence>
```

## Common Patterns and When to Use Each Property

| Scenario | Property | Value |
|---|---|---|
| Chapter starts on a new page | `break-before` on chapter block | `page` |
| Chapter starts on right-hand page | `break-before` on chapter block | `odd-page` |
| Heading never orphaned from its first paragraph | `keep-with-next.within-page` on heading | `always` |
| Figure and caption stay together | `keep-with-next.within-page` on figure, `keep-with-previous.within-page` on caption | `always` |
| Short block never splits across pages | `keep-together.within-page` on the block | `always` |
| Table row group stays on one page | `keep-together.within-page` on a wrapper block | `always` |
| At least 3 lines before a page break | `orphans` on the block | `3` |
| At least 3 lines after a page break | `widows` on the block | `3` |
| Preferred but breakable grouping | `keep-with-next.within-page` | `5` (numeric) |
| Entire small table on one page | `keep-together.within-page` on `fo:table` | `always` |
| Category header stays with first data row | `keep-with-next.within-page` on category row | `always` |

## See Also

- properties-keeps-breaks -- Property definitions for `keep-together`, `keep-with-previous`, `keep-with-next`, `break-before`, and `break-after`
- guide-area-model -- Area model concepts including context-areas, leading/trailing definitions, and area tree structure
- guide-datatypes -- The `<keep>` compound datatype used by keep properties
- guide-spaces-conditionality -- Space resolution rules that interact with page and column boundaries
