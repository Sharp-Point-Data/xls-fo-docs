# fo:retrieve-marker

## Summary

The `fo:retrieve-marker` is used in conjunction with `fo:marker` to produce running headers or footers. Typical examples include dictionary headers showing the first and last word defined on the page, and headers showing the page's chapter and section titles.

<!-- Source: https://www.w3.org/TR/xslfo20/#fo_retrieve-marker -->

## Areas

The `fo:retrieve-marker` does not directly generate any area. It is (conceptually) replaced by the children of the `fo:marker` that it retrieves.

## Trait Derivation

The properties and traits specified on the ancestors of the `fo:retrieve-marker` are taken into account when formatting the children of the retrieved `fo:marker` as if the children had the same ancestors as the `fo:retrieve-marker`.

## Constraints

- An `fo:retrieve-marker` is only permitted as the descendant of an `fo:static-content`.
- The `fo:retrieve-marker` specifies that the children of a selected `fo:marker` shall be formatted as though they replaced the `fo:retrieve-marker` in the formatting tree.
- The properties of the `fo:retrieve-marker` impose a hierarchy of preference on the areas of the area tree. Each `fo:marker` is conceptually attached to each normal area returned by the `fo:marker`'s parent formatting object. Additionally, an `fo:marker` is conceptually attached to each non-normal area that is directly generated by the `fo:marker`'s parent formatting object.
- The `fo:marker` whose children are retrieved is the one that is (conceptually) attached to the area that is at the top of this hierarchy.
- The term "containing page" is used to mean the page that contains the first area generated or returned by the children of the retrieved `fo:marker`.
- A qualifying area is one that has an attached `fo:marker` whose `marker-class-name` property value is the same as the `retrieve-class-name` property value of the `fo:retrieve-marker`.
- Qualifying area selection rules based on `retrieve-position`:
  - "first-starting-within-page": the first qualifying area in the containing page whose "is-first" trait has a value of "true" is preferred. If none, the first qualifying area in the containing page is preferred.
  - "first-including-carryover": the first qualifying area in the containing page is preferred.
  - "last-starting-within-page": the last qualifying area in the containing page whose "is-first" trait has a value of "true" is preferred. If none, the last qualifying area in the containing page is preferred.
  - "last-ending-within-page": the last qualifying area in the containing page whose "is-last" trait has a value of "true" is preferred. If none, the last qualifying area in the containing page is preferred.
- The `retrieve-boundary` property limits which pages are considered:
  - "page-sequence": areas from preceding page-sequences are excluded.
  - "page": only areas on the containing page are considered.
- If the hierarchy of areas is empty, no formatting objects are retrieved.

## Content Model

<!-- Source: https://www.w3.org/TR/xslfo20/#fo_retrieve-marker -->
```xml
EMPTY
```

## Properties

| Property | Inherited | Conformance Level |
|---|---|---|
| `retrieve-class-name` | no | Extended |
| `retrieve-position` | no | Extended |
| `retrieve-boundary` | no | Extended |

## Usage Notes

- The `retrieve-class-name` property must match the `marker-class-name` of the `fo:marker` whose content should be retrieved.
- The `retrieve-position` property controls which marker instance is selected when multiple markers with the same class name exist on a page. Common values are "first-starting-within-page" and "last-starting-within-page".
- The `retrieve-boundary` property controls the scope of the search for markers. Use "page" to limit retrieval to the current page, "page-sequence" to include markers from preceding pages in the same page-sequence, or "document" for the entire document.
- The `fo:retrieve-marker` must appear within `fo:static-content` (used for page headers and footers). It cannot appear within `fo:flow`.
- Properties set on ancestors of the `fo:marker` in the flow are NOT inherited by the marker's content when it is retrieved. The marker content inherits from the ancestors of the `fo:retrieve-marker` instead.

## Code Samples

The following three-part example from the spec demonstrates how fo:marker and fo:retrieve-marker work together to produce a table of contents with fo:leader dot leaders, fo:basic-link hyperlinks, and fo:page-number-citation page references.

### Source XML input with chapters and sections

<!-- Source: https://www.w3.org/TR/xslfo20/#fo_alternative-copyfit-content -->
```xml
<doc>
  <chapter><title>Chapter</title>
    <p>Text</p>
    <section><title>Section</title>
    <p>Text</p>
    </section>
    <section><title>Section</title>
    <p>Text</p>
    </section>
  </chapter>
  <chapter><title>Chapter</title>
    <p>Text</p>
    <section><title>Section</title>
    <p>Text</p>
    </section>
    <section><title>Section</title>
    <p>Text</p>
    </section>
  </chapter>
</doc>
```

### XSLT stylesheet using fo:marker, fo:retrieve-marker, fo:leader, fo:basic-link, and fo:page-number-citation for TOC and running headers

<!-- Source: https://www.w3.org/TR/xslfo20/#fo_alternative-copyfit-content -->
```xml
<?xml version='1.0'?>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
                xmlns:fo="http://www.w3.org/1999/XSL/Format"
                version='1.0'>

<xsl:template match="doc">
  <!-- create the table of contents -->
  <xsl:apply-templates select="chapter/title" mode="toc"/>
  <!-- do the document -->
  <xsl:apply-templates/>
</xsl:template>

<xsl:template match="chapter/title" mode="toc">
  <fo:block text-align-last="justify">
    <fo:basic-link internal-destination="{generate-id(.)}">
      <xsl:number level="multiple" count="chapter" format="1. "/>
      <xsl:apply-templates/>
    </fo:basic-link>
    <xsl:text> </xsl:text>
    <fo:leader leader-length.minimum="12pt" leader-length.optimum="40pt"
               leader-length.maximum="100%" leader-pattern="dots"/>
    <xsl:text> </xsl:text>
    <fo:page-number-citation ref-id="{generate-id(.)}"/>
  </fo:block>
  <xsl:apply-templates select="../section/title" mode="toc"/>
</xsl:template>

<xsl:template match="section/title" mode="toc">
  <fo:block start-indent="10mm" text-align-last="justify">
    <fo:basic-link internal-destination="{generate-id(.)}">
      <xsl:number level="multiple" count="chapter|section" format="1.1 "/>
      <xsl:apply-templates/>
    </fo:basic-link>
    <xsl:text> </xsl:text>
    <fo:leader leader-length.minimum="12pt" leader-length.optimum="40pt"
               leader-length.maximum="100%" leader-pattern="dots"/>
    <xsl:text> </xsl:text>
    <fo:page-number-citation ref-id="{generate-id(.)}"/>
  </fo:block>
</xsl:template>

<xsl:template match="chapter/title">
  <fo:block id="{generate-id(.)}">
    <xsl:number level="multiple" count="chapter" format="1. "/>
    <xsl:apply-templates/>
  </fo:block>
</xsl:template>

<xsl:template match="section/title">
  <fo:block id="{generate-id(.)}">
    <xsl:number level="multiple" count="chapter|section" format="1.1 "/>
    <xsl:apply-templates/>
  </fo:block>
</xsl:template>

<xsl:template match="p">
  <fo:block>
    <xsl:apply-templates/>
  </fo:block>
</xsl:template>

</xsl:stylesheet>
```

### Resulting XSL-FO output with TOC entries using fo:basic-link, fo:leader, and fo:page-number-citation, followed by body content

<!-- Source: https://www.w3.org/TR/xslfo20/#fo_alternative-copyfit-content -->
```xml
<fo:block text-align-last="justify">
  <fo:basic-link internal-destination="N4">1. Chapter
  </fo:basic-link>
  <fo:leader leader-length.minimum="12pt" leader-length.optimum="40pt"
    leader-length.maximum="100%" leader-pattern="dots">
  </fo:leader>
  <fo:page-number-citation ref-id="N4">
  </fo:page-number-citation>
</fo:block>
<fo:block start-indent="10mm" text-align-last="justify">
  <fo:basic-link internal-destination="N11">1.1 Section
  </fo:basic-link>
  <fo:leader leader-length.minimum="12pt" leader-length.optimum="40pt"
    leader-length.maximum="100%" leader-pattern="dots">
  </fo:leader>
  <fo:page-number-citation ref-id="N11">
  </fo:page-number-citation>
</fo:block>
<fo:block start-indent="10mm" text-align-last="justify">
  <fo:basic-link internal-destination="N19">1.2 Section
  </fo:basic-link>
  <fo:leader leader-length.minimum="12pt" leader-length.optimum="40pt"
    leader-length.maximum="100%" leader-pattern="dots">
  </fo:leader>
  <fo:page-number-citation ref-id="N19">
  </fo:page-number-citation>
</fo:block>
<fo:block text-align-last="justify">
  <fo:basic-link internal-destination="N28">2. Chapter
  </fo:basic-link>
  <fo:leader leader-length.minimum="12pt" leader-length.optimum="40pt"
    leader-length.maximum="100%" leader-pattern="dots">
  </fo:leader>
  <fo:page-number-citation ref-id="N28">
  </fo:page-number-citation>
</fo:block>
<fo:block start-indent="10mm" text-align-last="justify">
  <fo:basic-link internal-destination="N35">2.1 Section
  </fo:basic-link>
  <fo:leader leader-length.minimum="12pt" leader-length.optimum="40pt"
    leader-length.maximum="100%" leader-pattern="dots">
  </fo:leader>
  <fo:page-number-citation ref-id="N35">
  </fo:page-number-citation>
</fo:block>
<fo:block start-indent="10mm" text-align-last="justify">
  <fo:basic-link internal-destination="N43">2.2 Section
  </fo:basic-link>
  <fo:leader leader-length.minimum="12pt" leader-length.optimum="40pt"
    leader-length.maximum="100%" leader-pattern="dots">
  </fo:leader>
  <fo:page-number-citation ref-id="N43">
  </fo:page-number-citation>
</fo:block>

<fo:block id="N4">1. Chapter
</fo:block>

<fo:block>Text
</fo:block>

<fo:block id="N11">1.1 Section
</fo:block>

<fo:block>Text
</fo:block>

<fo:block id="N19">1.2 Section
</fo:block>

<fo:block>Text
</fo:block>

<fo:block id="N28">2. Chapter
</fo:block>

<fo:block>Text
</fo:block>

<fo:block id="N35">2.1 Section
</fo:block>

<fo:block>Text
</fo:block>

<fo:block id="N43">2.2 Section
</fo:block>

<fo:block>Text
</fo:block>
```

## See Also

- `fo:marker` -- defines the content that can be retrieved
- `fo:retrieve-table-marker` -- retrieves marker content within table headers/footers
- `fo:static-content` -- the context in which retrieve-marker must appear
